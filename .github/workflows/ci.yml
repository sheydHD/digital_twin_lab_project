name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Lint with pylint (non-blocking)
      run: |
        pylint apps/ tests/ || echo "Pylint found issues but continuing..."
      continue-on-error: true

    - name: Check formatting with black
      run: |
        black --check apps/ tests/ || echo "Black formatting issues found"
      continue-on-error: true

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=apps --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Check markdown files exist
      run: |
        echo "Checking documentation structure..."
        ls -la docs/
        ls -la *.md
        echo "Documentation check passed!"

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check for security vulnerabilities (non-blocking)
      run: |
        safety check || echo "Safety check completed with warnings"
        bandit -r apps/ -ll || echo "Bandit scan completed"
      continue-on-error: true

  deploy-docs:
    runs-on: ubuntu-latest
    needs: [test, docs, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Build documentation site
      run: |
        mkdir -p _site
        cp README.md _site/index.md
        cp -r docs _site/
        cp LICENSE _site/
        cp CODE_OF_CONDUCT.md _site/
        cp CONTRIBUTING.md _site/
        cp CHANGELOG.md _site/
        cp SECURITY.md _site/
        cp AUTHORS.md _site/
        
        # Create a simple index.html that redirects to the markdown
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Digital Twin Lab - Bayesian Beam Model Selection</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                    line-height: 1.6;
                }
                .header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 40px;
                    border-radius: 10px;
                    text-align: center;
                    margin-bottom: 30px;
                }
                .docs-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                    margin: 30px 0;
                }
                .doc-card {
                    border: 2px solid #e2e8f0;
                    padding: 20px;
                    border-radius: 8px;
                    text-decoration: none;
                    color: inherit;
                    transition: all 0.3s;
                }
                .doc-card:hover {
                    border-color: #667eea;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
                }
                .doc-title {
                    font-size: 18px;
                    font-weight: bold;
                    color: #2d3748;
                    margin-bottom: 10px;
                }
                .doc-desc {
                    font-size: 14px;
                    color: #718096;
                }
                .footer {
                    text-align: center;
                    margin-top: 50px;
                    padding-top: 20px;
                    border-top: 1px solid #e2e8f0;
                    color: #718096;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üèóÔ∏è Digital Twin Lab</h1>
                <h2>Bayesian Model Selection for Beam Theory in Structural Health Monitoring</h2>
                <p>RWTH Aachen University - Antoni Dudij & Maksim Feldmann</p>
            </div>

            <h2>üìö Documentation</h2>
            <div class="docs-grid">
                <a href="docs/GETTING_STARTED.md" class="doc-card">
                    <div class="doc-title">üöÄ Getting Started</div>
                    <div class="doc-desc">Installation, setup, and first run</div>
                </a>
                <a href="docs/EXPLANATION.md" class="doc-card">
                    <div class="doc-title">üìñ Explanation</div>
                    <div class="doc-desc">Plain-English project guide</div>
                </a>
                <a href="docs/ARCHITECTURE.md" class="doc-card">
                    <div class="doc-title">üèóÔ∏è Architecture</div>
                    <div class="doc-desc">System design and patterns</div>
                </a>
                <a href="docs/API.md" class="doc-card">
                    <div class="doc-title">üîß API Reference</div>
                    <div class="doc-desc">Complete API documentation</div>
                </a>
                <a href="docs/DEVELOPMENT.md" class="doc-card">
                    <div class="doc-title">üíª Development</div>
                    <div class="doc-desc">Dev setup and best practices</div>
                </a>
                <a href="docs/INDEX.md" class="doc-card">
                    <div class="doc-title">üóÇÔ∏è Full Index</div>
                    <div class="doc-desc">Complete documentation index</div>
                </a>
            </div>

            <h2>üìã Project Resources</h2>
            <div class="docs-grid">
                <a href="CONTRIBUTING.md" class="doc-card">
                    <div class="doc-title">ü§ù Contributing</div>
                    <div class="doc-desc">How to contribute</div>
                </a>
                <a href="CODE_OF_CONDUCT.md" class="doc-card">
                    <div class="doc-title">üìú Code of Conduct</div>
                    <div class="doc-desc">Community standards</div>
                </a>
                <a href="AUTHORS.md" class="doc-card">
                    <div class="doc-title">üë• Authors</div>
                    <div class="doc-desc">Project developers</div>
                </a>
                <a href="CHANGELOG.md" class="doc-card">
                    <div class="doc-title">üì∞ Changelog</div>
                    <div class="doc-desc">Version history</div>
                </a>
                <a href="SECURITY.md" class="doc-card">
                    <div class="doc-title">üîê Security</div>
                    <div class="doc-desc">Security policy</div>
                </a>
                <a href="LICENSE" class="doc-card">
                    <div class="doc-title">‚öñÔ∏è License</div>
                    <div class="doc-desc">MIT License</div>
                </a>
            </div>

            <div class="footer">
                <p><strong>GitHub Repository:</strong> <a href="https://github.com/sheydHD/digital_twin_lab_project">sheydHD/digital_twin_lab_project</a></p>
                <p>Made with ‚ù§Ô∏è by Antoni Dudij & Maksim Feldmann - RWTH Aachen University</p>
            </div>
        </body>
        </html>
        EOF

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4